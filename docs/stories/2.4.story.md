# Story 2.4: Smart Task De-duplication

## Status
 Approved

## Story
**As a** user with tasks from multiple sources,
**I want** the system to automatically identify and merge duplicate tasks,
**so that** my unified list is clean and I don't see the same work item multiple times.

## Acceptance Criteria
1. A backend process is implemented to analyze tasks from all sources for potential duplicates based on title, description, and other metadata.
2. When a duplicate is identified, the tasks are merged into a single entry in the Syntaskio UI.
3. The merged task entry clearly indicates all of its source systems (e.g., shows both "ConnectWise" and "Microsoft Todo" indicators).
4. Completing a merged task updates the status in all of its source systems.

## Tasks / Subtasks
- [x] Task 1: Design and implement duplicate detection algorithm (AC: 1)
  - [x] Research and implement fuzzy text matching algorithms
  - [x] Create scoring system for duplicate probability
  - [x] Implement metadata-based matching (dates, assignees, priorities)
  - [x] Add configurable similarity thresholds and matching rules
- [x] Task 2: Create task merging service and data model (AC: 2)
  - [x] Design merged task data structure with multiple source references
  - [x] Implement task merging logic with conflict resolution
  - [x] Create merged task repository and database schema
  - [x] Add task relationship tracking for merge history
- [ ] Task 3: Integrate duplicate detection with task aggregation (AC: 1, 2)
  - [ ] Add duplicate detection to task synchronization pipeline
  - [ ] Implement real-time duplicate checking for new tasks
  - [ ] Create background job for existing task deduplication
  - [ ] Add duplicate detection performance optimization
- [ ] Task 4: Update frontend for merged task display (AC: 3)
  - [ ] Design merged task UI with multiple source indicators
  - [ ] Update TaskCard component to show all source systems
  - [ ] Create merged task detail view with source breakdown
  - [ ] Add visual indicators for merged vs. single-source tasks
- [ ] Task 5: Extend bi-directional sync for merged tasks (AC: 4)
  - [ ] Update sync service to handle multi-source task updates
  - [ ] Implement parallel sync to all source systems for merged tasks
  - [ ] Add merged task conflict resolution for sync failures
  - [ ] Create sync status tracking for multiple sources
- [ ] Task 6: Create user controls for merge management (AC: 2, 3)
  - [ ] Add manual merge/unmerge functionality
  - [ ] Create duplicate suggestion review interface
  - [ ] Implement merge conflict resolution UI
  - [ ] Add user preferences for auto-merge sensitivity
- [ ] Task 7: Create comprehensive testing (AC: 1-4)
  - [ ] Write unit tests for duplicate detection algorithms
  - [ ] Write integration tests for task merging workflows
  - [ ] Create E2E tests for complete deduplication pipeline
  - [ ] Test merged task sync across multiple providers
  - [ ] Performance testing with large datasets and fuzzy matching

## Dev Notes

### Previous Story Insights
From Stories 1.1-2.3, the foundation provides:
- Complete authentication system with GCP Identity Platform
- Microsoft Todo, ConnectWise Manage, and Process Plan integrations
- Unified Task Dashboard with multi-source task display
- Task aggregation service with scheduled synchronization
- Bi-directional sync service with queue-based processing
- Comprehensive task data models supporting all integration sources

### Duplicate Detection Algorithm Design
[Source: Machine Learning and Fuzzy Matching Best Practices]

#### Primary Matching Criteria
1. **Title Similarity**: Fuzzy string matching using Levenshtein distance
2. **Description Similarity**: TF-IDF vector similarity for longer text
3. **Temporal Proximity**: Tasks created/due within similar timeframes
4. **Assignee Matching**: Same user across different systems
5. **Priority Alignment**: Similar priority levels across sources

#### Scoring Algorithm
```typescript
interface DuplicateScore {
  titleSimilarity: number; // 0-1, weight: 40%
  descriptionSimilarity: number; // 0-1, weight: 25%
  temporalProximity: number; // 0-1, weight: 15%
  assigneeMatch: number; // 0-1, weight: 10%
  priorityMatch: number; // 0-1, weight: 10%
  overallScore: number; // Weighted average
  confidence: 'high' | 'medium' | 'low';
}

// Overall duplicate threshold: 0.75 for auto-merge, 0.60 for suggestion
```

#### Advanced Matching Features
- **Semantic Similarity**: Use embeddings for contextual text matching
- **Cross-Source Patterns**: Learn user's task naming patterns across systems
- **Time-Based Clustering**: Group tasks by project or time period
- **Metadata Correlation**: Match related fields (ticket numbers, project codes)

### Merged Task Data Model
```typescript
interface MergedTask {
  id: string;
  userId: string;
  title: string; // Primary title (usually from first source)
  description?: string; // Merged/primary description
  status: 'pending' | 'in_progress' | 'completed';
  priority?: 'low' | 'medium' | 'high';
  dueDate?: Date; // Earliest due date from sources
  
  // Merged task specific fields
  sourceIds: string[]; // Array of original task IDs
  sources: TaskSource[];
  mergedAt: Date;
  mergedBy: 'auto' | 'manual';
  confidence?: number;
  
  // Aggregated metadata
  allSources: ('microsoft' | 'connectwise' | 'processplan')[];
  sourceData: {
    [sourceType: string]: object; // Combined source-specific data
  };
}

interface TaskSource {
  taskId: string;
  source: 'microsoft' | 'connectwise' | 'processplan';
  originalTitle: string;
  originalDescription?: string;
  originalStatus: string;
  integrationId: string;
  lastSyncAt?: Date;
}

interface DuplicateCandidate {
  id: string;
  task1Id: string;
  task2Id: string;
  score: DuplicateScore;
  status: 'pending' | 'approved' | 'rejected' | 'auto_merged';
  reviewedBy?: string;
  reviewedAt?: Date;
  createdAt: Date;
}
```

### Database Schema Updates
```sql
-- Merged tasks table
CREATE TABLE merged_tasks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    title TEXT NOT NULL,
    description TEXT,
    status TEXT NOT NULL DEFAULT 'pending',
    priority TEXT,
    due_date TIMESTAMPTZ,
    merged_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    merged_by TEXT NOT NULL DEFAULT 'auto',
    confidence NUMERIC(3,2),
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Task sources for merged tasks
CREATE TABLE merged_task_sources (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    merged_task_id UUID NOT NULL REFERENCES merged_tasks(id) ON DELETE CASCADE,
    original_task_id UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
    source TEXT NOT NULL,
    original_title TEXT NOT NULL,
    original_description TEXT,
    original_status TEXT NOT NULL,
    integration_id UUID NOT NULL REFERENCES integrations(id),
    last_sync_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Duplicate candidates for review
CREATE TABLE duplicate_candidates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    task1_id UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
    task2_id UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
    title_similarity NUMERIC(3,2),
    description_similarity NUMERIC(3,2),
    temporal_proximity NUMERIC(3,2),
    assignee_match NUMERIC(3,2),
    priority_match NUMERIC(3,2),
    overall_score NUMERIC(3,2),
    confidence TEXT,
    status TEXT DEFAULT 'pending',
    reviewed_by UUID REFERENCES users(id),
    reviewed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Update tasks table to reference merged tasks
ALTER TABLE tasks ADD COLUMN merged_task_id UUID REFERENCES merged_tasks(id);
ALTER TABLE tasks ADD COLUMN is_merged BOOLEAN DEFAULT FALSE;

-- Indexes for performance
CREATE INDEX idx_merged_tasks_user_id ON merged_tasks(user_id);
CREATE INDEX idx_merged_task_sources_merged_task_id ON merged_task_sources(merged_task_id);
CREATE INDEX idx_duplicate_candidates_score ON duplicate_candidates(overall_score DESC);
CREATE INDEX idx_tasks_merged_task_id ON tasks(merged_task_id);
```

### Duplicate Detection Pipeline
[Source: architecture/backend-architecture.md]

#### Real-Time Detection
1. **New Task Processing**: Check for duplicates when tasks are created/updated
2. **Similarity Scoring**: Calculate duplicate probability using multi-factor algorithm
3. **Auto-Merge Decision**: Automatically merge high-confidence duplicates (>0.75)
4. **Suggestion Queue**: Queue medium-confidence duplicates (0.60-0.75) for review

#### Background Processing
1. **Batch Analysis**: Periodic analysis of all user tasks for potential duplicates
2. **Cross-Source Matching**: Compare tasks across different integration sources
3. **Pattern Learning**: Adapt matching criteria based on user merge/reject decisions
4. **Performance Optimization**: Efficient similarity calculations for large datasets

### Frontend Merge Management
[Source: architecture/frontend-architecture.md]

#### Merged Task Display
- **Multi-Source Badges**: Display all source system indicators on task cards
- **Source Breakdown**: Detailed view showing original tasks from each source
- **Merge History**: Timeline of when and how tasks were merged
- **Conflict Indicators**: Visual cues for data conflicts between sources

#### User Controls
- **Merge Review**: Interface for approving/rejecting suggested duplicates
- **Manual Merge**: Drag-and-drop or selection-based manual merging
- **Unmerge Tasks**: Split merged tasks back into original components
- **Merge Preferences**: User settings for auto-merge sensitivity

### Bi-Directional Sync for Merged Tasks
[Source: Story 2.3 sync service patterns]

#### Multi-Source Sync Strategy
1. **Parallel Updates**: Simultaneously update all source systems
2. **Partial Failure Handling**: Handle cases where some sources fail to sync
3. **Conflict Resolution**: Resolve sync conflicts between different sources
4. **Status Consolidation**: Determine merged task status from source statuses

#### Sync Queue Extensions
```typescript
interface MergedTaskSyncJob extends SyncJob {
  mergedTaskId: string;
  sourceTaskIds: string[];
  sources: string[];
  syncResults: {
    [source: string]: SyncResult;
  };
}
```

### Performance Considerations
- **Similarity Calculation**: Optimize fuzzy matching algorithms for large datasets
- **Indexing Strategy**: Database indexes for efficient duplicate candidate queries
- **Caching**: Cache similarity calculations and user merge preferences
- **Background Processing**: Limit duplicate detection to prevent performance impact

### Security and Privacy
[Source: architecture/security-and-performance.md]
- **Data Isolation**: Ensure duplicate detection only operates within user's tasks
- **Audit Logging**: Track all merge/unmerge operations for accountability
- **Permission Validation**: Verify user permissions for merge operations
- **Sensitive Data**: Handle confidential task content appropriately in matching

### File Locations
Based on established service patterns:
- Duplicate detection: `apps/api/src/deduplication/`
- Detection algorithm: `apps/api/src/deduplication/duplicate-detector.service.ts`
- Merge service: `apps/api/src/deduplication/task-merge.service.ts`
- Duplicate controller: `apps/api/src/deduplication/deduplication.controller.ts`
- Frontend merge components: `apps/web/src/components/tasks/merge/`
- Merge store: `apps/web/src/stores/merge.store.ts`
- Deduplication types: `packages/shared-types/src/deduplication.ts`

### Technical Constraints
- TypeScript 5.5.x must be used consistently across all packages
- Duplicate detection must not impact task aggregation performance
- Merge operations must be atomic and reversible
- All merge decisions must be auditable and trackable
- Similarity calculations must be deterministic and reproducible
- Multi-source sync must handle partial failures gracefully

### Integration Points
- **Task Aggregation Service**: Integrate duplicate detection in sync pipeline
- **Bi-Directional Sync**: Extend sync service for merged task updates
- **Task Dashboard**: Update UI components for merged task display
- **Background Jobs**: Scheduled duplicate detection and cleanup
- **WebSocket Service**: Real-time updates for merge operations

## Testing
[Source: architecture/testing-coding-error-handling-and-monitoring-standards.md]
- **Unit Tests**: Duplicate detection algorithms, merge logic, similarity calculations
- **Integration Tests**: End-to-end deduplication pipeline, multi-source sync
- **E2E Tests**: Complete merge workflow from detection to UI display
- **Performance Tests**: Large dataset duplicate detection, fuzzy matching efficiency
- **Algorithm Tests**: Similarity algorithm accuracy with known duplicate pairs
- **Security Tests**: Data isolation, permission validation, audit logging

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-02 | 1.0 | Initial story creation | Claude Code |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
Claude Sonnet 4 (Augment Agent)

### Debug Log References
- 2025-08-02: Comprehensive review identified critical gaps in Task interface and TaskService mappings
- 2025-08-02: Fixed missing mergedTaskId and isMerged fields in Task interface
- 2025-08-02: Updated all TaskService mapping functions to include merged task fields
- 2025-08-02: Created DuplicateDetectionPipelineService for task aggregation integration
- 2025-08-02: All 33 tests passing across deduplication services

### Completion Notes List
- Started implementation of Task 1: Design and implement duplicate detection algorithm
- Completed Task 1: Implemented comprehensive duplicate detection algorithm with fuzzy text matching, TF-IDF similarity, temporal proximity, assignee matching, and configurable scoring system
- Created deduplication types and interfaces in shared-types package
- Implemented Levenshtein distance and Jaro-Winkler algorithms for title similarity
- Added TF-IDF cosine similarity for description matching
- Created comprehensive test suite with 13 passing tests for DuplicateDetectorService
- Completed Task 2: Implemented task merging service with conflict resolution, database schema updates, and comprehensive test coverage
- Created merged task data model with multiple source references and relationship tracking
- Implemented merge/unmerge functionality with proper status, priority, and due date resolution
- Added 13 passing tests for TaskMergeService
- CRITICAL FIXES APPLIED: Updated Task interface with merged task fields, fixed TaskService mappings, created integration pipeline
- Created DuplicateDetectionPipelineService for real-time duplicate detection during task aggregation
- Added 7 passing tests for DeduplicationService
- Total test coverage: 33 tests passing across all deduplication services

### File List
- packages/shared-types/src/deduplication.ts (NEW)
- packages/shared-types/src/index.ts (MODIFIED)
- packages/shared-types/src/task.ts (MODIFIED - Added merged task fields)
- apps/api/src/deduplication/duplicate-detector.service.ts (NEW)
- apps/api/src/deduplication/task-merge.service.ts (NEW)
- apps/api/src/deduplication/deduplication.service.ts (NEW)
- apps/api/src/deduplication/deduplication.controller.ts (NEW)
- apps/api/src/deduplication/deduplication.module.ts (NEW)
- apps/api/src/deduplication/duplicate-detection-pipeline.service.ts (NEW)
- apps/api/src/deduplication/duplicate-detector.service.spec.ts (NEW)
- apps/api/src/deduplication/task-merge.service.spec.ts (NEW)
- apps/api/src/deduplication/deduplication.service.spec.ts (NEW)
- apps/api/src/task/task.service.ts (MODIFIED - Updated mappings for merged task fields)
- apps/api/src/app.module.ts (MODIFIED)
- apps/api/prisma/schema.prisma (MODIFIED)

## QA Results
*Results from QA Agent review will be populated here after implementation*