# Story 2.1: ConnectWise Manage Integration

## Status
Approved

## Story
**As an** authenticated user,
**I want to** connect my ConnectWise Manage account,
**so that** Syntaskio can aggregate my assigned tickets and project tasks.

## Acceptance Criteria
1. A user can initiate an OAuth2 connection to their ConnectWise Manage account from the Integration Settings page.
2. The backend service can securely store and use the authorization token to fetch data.
3. The service correctly retrieves both open service tickets and active project tasks assigned to the user.
4. Tasks from ConnectWise are correctly displayed on the Unified Task Dashboard with a "ConnectWise" source indicator.

## Tasks / Subtasks
- [x] Task 1: Research and configure ConnectWise Manage API (AC: 1, 2)
  - [x] Research ConnectWise Manage REST API authentication
  - [x] Configure ConnectWise API credentials and OAuth2 flow
  - [x] Set up API permissions for tickets and project tasks
  - [x] Create ConnectWise OAuth2 documentation
- [x] Task 2: Implement ConnectWise OAuth2 backend service (AC: 1, 2)
  - [x] Create ConnectWise provider module in integration system
  - [x] Implement ConnectWise OAuth2 flow and token management
  - [x] Add ConnectWise-specific authentication controller
  - [x] Integrate with existing encrypted token storage
- [ ] Task 3: Create ConnectWise API client service (AC: 2, 3)
  - [ ] Implement ConnectWise REST API client
  - [ ] Create service ticket fetching functionality
  - [ ] Create project task fetching functionality
  - [ ] Add comprehensive error handling and retries
  - [ ] Implement rate limiting for ConnectWise API calls
- [ ] Task 4: Extend data models for ConnectWise integration (AC: 3)
  - [ ] Update Task interface to support ConnectWise fields
  - [ ] Add ConnectWise-specific task properties (ticket type, company, etc.)
  - [ ] Update database schema for ConnectWise task metadata
  - [ ] Create task transformation from ConnectWise format
- [ ] Task 5: Integrate ConnectWise with task aggregation service (AC: 3, 4)
  - [ ] Add ConnectWise provider to task aggregation orchestrator
  - [ ] Implement ConnectWise task synchronization
  - [ ] Add ConnectWise to scheduled sync jobs
  - [ ] Update task dashboard to display ConnectWise tasks
- [ ] Task 6: Update frontend for ConnectWise integration (AC: 1, 4)
  - [ ] Add ConnectWise option to Integration Settings page
  - [ ] Update TaskCard component for ConnectWise source indicator
  - [ ] Add ConnectWise-specific task filtering
  - [ ] Create ConnectWise connection status display
- [ ] Task 7: Create comprehensive testing (AC: 1-4)
  - [ ] Write unit tests for ConnectWise API client
  - [ ] Write integration tests for ConnectWise OAuth2 flow
  - [ ] Create E2E tests for ConnectWise integration workflow
  - [ ] Test ConnectWise task display and filtering
  - [ ] Performance testing with large ConnectWise datasets

## Dev Notes

### Previous Story Insights
From Stories 1.1-1.4, the foundation provides:
- Complete authentication system with GCP Identity Platform
- Microsoft Todo integration with OAuth2 and secure token storage
- Unified Task Dashboard with responsive design and filtering
- Task aggregation service with scheduled synchronization
- Encrypted token storage and comprehensive error handling

### ConnectWise Manage API Overview
[Source: ConnectWise Developer Documentation]
- **Base URL**: `https://{company}.api.connectwisedev.com/v4_6_release/apis/3.0`
- **Authentication**: OAuth2 with public/confidential client types
- **API Endpoints**:
  - `/service/tickets` - Service tickets
  - `/project/projects/{id}/tasks` - Project tasks
  - `/system/members/{id}` - User information
- **Rate Limits**: 1000 requests per hour per integration
- **Required Scopes**: `ConnectWiseManageCallback`, `ServiceTicket`, `ProjectTask`

### ConnectWise Data Structures
**Service Tickets:**
```json
{
  "id": 12345,
  "summary": "Ticket summary",
  "board": {"name": "Service Board"},
  "status": {"name": "New"},
  "priority": {"name": "Medium"},
  "company": {"name": "Client Company"},
  "owner": {"identifier": "user@company.com"},
  "dateEntered": "2024-08-01T10:00:00Z",
  "requiredDate": "2024-08-05T17:00:00Z"
}
```

**Project Tasks:**
```json
{
  "id": 67890,
  "name": "Task name",
  "project": {"name": "Project Name"},
  "status": {"name": "Open"},
  "priority": {"name": "High"},
  "assignedTo": {"identifier": "user@company.com"},
  "dateStart": "2024-08-01T09:00:00Z",
  "dateDue": "2024-08-03T17:00:00Z"
}
```

### Data Model Extensions
[Source: packages/shared-types from previous stories]
```typescript
interface Task {
  // Existing fields...
  id: string;
  title: string;
  description?: string;
  status: 'pending' | 'in_progress' | 'completed';
  priority?: 'low' | 'medium' | 'high';
  dueDate?: Date;
  source: 'microsoft' | 'connectwise' | 'processplan';
  
  // ConnectWise-specific extensions
  sourceData: {
    // Microsoft Todo fields...
    // ConnectWise fields
    ticketId?: number;
    taskId?: number;
    boardName?: string;
    projectName?: string;
    companyName?: string;
    ticketType?: 'service' | 'project';
    requiredDate?: string;
    owner?: string;
    assignedTo?: string;
  };
}

interface Integration {
  // Existing fields...
  provider: 'microsoft' | 'connectwise' | 'processplan';
  
  // ConnectWise-specific configuration
  config?: {
    companyId?: string;
    serverUrl?: string;
    memberId?: string;
  };
}
```

### ConnectWise Authentication Flow
1. **Registration**: User provides ConnectWise server URL and company ID
2. **OAuth2 Initiation**: Redirect to ConnectWise OAuth2 authorization
3. **Callback Handling**: Receive authorization code and exchange for tokens
4. **Token Storage**: Encrypt and store access/refresh tokens
5. **API Access**: Use tokens to authenticate ConnectWise API calls

### API Integration Architecture
[Source: architecture/backend-architecture.md]
- **ConnectWise Provider**: `apps/api/src/integration/providers/connectwise/`
- **API Client**: ConnectWise REST API wrapper with error handling
- **Task Transformation**: Convert ConnectWise tickets/tasks to unified Task format
- **Sync Strategy**: Incremental sync with last-modified timestamps
- **Error Handling**: Retry logic for API failures and rate limiting

### Frontend Integration Points
[Source: architecture/frontend-architecture.md]
- **Integration Settings**: Add ConnectWise connection option with server URL input
- **Task Display**: ConnectWise source badge with distinctive styling
- **Filtering**: Add ConnectWise-specific filters (board, project, company)
- **Error Handling**: Display ConnectWise connection issues and retry options

### Security Considerations
[Source: architecture/security-and-performance.md]
- **Token Security**: Encrypt ConnectWise tokens with same encryption service
- **API Security**: Validate server URL to prevent SSRF attacks
- **Rate Limiting**: Respect ConnectWise API rate limits (1000/hour)
- **Data Privacy**: Handle client company data with appropriate care

### Performance Requirements
- **Sync Performance**: Handle 1000+ tickets/tasks efficiently
- **API Efficiency**: Batch requests where possible
- **Error Recovery**: Graceful handling of ConnectWise server downtime
- **Caching**: Cache ConnectWise metadata (boards, projects, companies)

### File Locations
Based on established patterns from Microsoft integration:
- ConnectWise provider: `apps/api/src/integration/providers/connectwise/`
- ConnectWise module: `apps/api/src/integration/providers/connectwise/connectwise.module.ts`
- ConnectWise service: `apps/api/src/integration/providers/connectwise/connectwise.service.ts`
- ConnectWise API client: `apps/api/src/integration/providers/connectwise/connectwise-api.service.ts`
- ConnectWise auth controller: `apps/api/src/integration/providers/connectwise/connectwise-auth.controller.ts`
- Frontend integration page: `apps/web/src/app/integrations/page.tsx` (extend existing)
- ConnectWise types: `packages/shared-types/src/connectwise.ts`

### Technical Constraints
- TypeScript 5.5.x must be used consistently across all packages
- Follow established OAuth2 patterns from Microsoft integration
- Use existing encrypted token storage service
- Integrate with existing task aggregation service
- Maintain compatibility with existing Task interface
- ConnectWise API rate limits must be respected
- Server URL validation to prevent security vulnerabilities

### Integration Testing Strategy
- **Unit Tests**: ConnectWise API client, task transformation, OAuth2 flow
- **Integration Tests**: End-to-end ConnectWise connection and task fetching
- **Security Tests**: Token encryption, server URL validation, API rate limiting
- **Performance Tests**: Large dataset handling, sync performance
- **Error Scenario Tests**: API failures, network issues, token expiration

## Testing
[Source: architecture/testing-coding-error-handling-and-monitoring-standards.md]
- **Unit Tests**: ConnectWise API service, task transformation logic, OAuth2 handling
- **Integration Tests**: ConnectWise API integration, task synchronization, error scenarios
- **E2E Tests**: Complete ConnectWise integration workflow, task display, filtering
- **Security Tests**: Token encryption, OAuth2 flow security, API validation
- **Performance Tests**: Large task list handling, API rate limiting, sync efficiency

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-02 | 1.0 | Initial story creation | Claude Code |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
Claude Sonnet 4 (Augment Agent)

### Debug Log References
- Task 1 implementation: ConnectWise API research and configuration completed
- Tests passing: connectwise.spec.ts (4/4 tests passed)

### Completion Notes List
- **Task 1 Complete**: Created comprehensive ConnectWise OAuth2 documentation with API details, security considerations, and implementation guidelines
- **Configuration Added**: Extended .env.example with ConnectWise environment variables
- **Tests Created**: Validation tests for documentation and configuration completeness
- **Research Complete**: All ConnectWise API authentication, scopes, and rate limits documented
- **Task 2 Complete**: Implemented complete ConnectWise OAuth2 backend service with provider module, authentication controller, and API client
- **Backend Services**: Created ConnectWiseService, ConnectWiseApiService, and ConnectWiseAuthController with comprehensive OAuth2 flow
- **Data Models**: Extended shared types with config and lastSyncAt fields for ConnectWise integration
- **Security**: Implemented server URL validation and secure token management
- **Testing**: All backend services tested with 11/11 tests passing

### File List
- `docs/integrations/connectwise-oauth2.md` (new) - Comprehensive ConnectWise OAuth2 integration documentation
- `apps/api/.env.example` (modified) - Added ConnectWise environment variables
- `apps/api/src/integration/providers/connectwise/connectwise.spec.ts` (new) - Configuration and backend service tests
- `apps/api/src/integration/providers/connectwise/connectwise.module.ts` (new) - ConnectWise provider module
- `apps/api/src/integration/providers/connectwise/connectwise.service.ts` (new) - Main ConnectWise service with OAuth2 flow
- `apps/api/src/integration/providers/connectwise/connectwise-api.service.ts` (new) - ConnectWise API client service
- `apps/api/src/integration/providers/connectwise/connectwise-auth.controller.ts` (new) - OAuth2 authentication controller
- `packages/shared-types/src/integration.ts` (modified) - Added config and lastSyncAt fields
- `apps/api/src/integration/integration.module.ts` (modified) - Added ConnectWise module import
- `apps/api/prisma/schema.prisma` (modified) - Added config and lastSyncAt fields to Integration model

## QA Results
*Results from QA Agent review will be populated here after implementation*