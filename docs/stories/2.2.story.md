# Story 2.2: Process Plan Integration

## Status
Ready for Implementation

## Story
**As an** authenticated user,
**I want to** connect my Process Plan account,
**so that** Syntaskio can aggregate my active processes.

## Acceptance Criteria
1. A user can initiate an OAuth2 connection to their Process Plan account from the Integration Settings page.
2. The backend service can securely store and use the authorization token to fetch data.
3. The service correctly retrieves all active processes assigned to the user.
4. Tasks from Process Plan are correctly displayed on the Unified Task Dashboard with a "Process Plan" source indicator.

## Tasks / Subtasks
- [ ] Task 1: Research and configure Process Plan API (AC: 1, 2)
  - [ ] Research Process Plan REST API authentication and OAuth2 flow
  - [ ] Configure Process Plan API credentials and scope requirements
  - [ ] Set up API permissions for process access
  - [ ] Create Process Plan OAuth2 integration documentation
- [ ] Task 2: Implement Process Plan OAuth2 backend service (AC: 1, 2)
  - [ ] Create Process Plan provider module in integration system
  - [ ] Implement Process Plan OAuth2 flow and token management
  - [ ] Add Process Plan-specific authentication controller
  - [ ] Integrate with existing encrypted token storage service
- [ ] Task 3: Create Process Plan API client service (AC: 2, 3)
  - [ ] Implement Process Plan REST API client
  - [ ] Create active process fetching functionality
  - [ ] Add process step and task extraction logic
  - [ ] Implement comprehensive error handling and retries
  - [ ] Add rate limiting for Process Plan API calls
- [ ] Task 4: Extend data models for Process Plan integration (AC: 3)
  - [ ] Update Task interface to support Process Plan fields
  - [ ] Add Process Plan-specific task properties (process name, step, status)
  - [ ] Update database schema for Process Plan task metadata
  - [ ] Create task transformation from Process Plan format
- [ ] Task 5: Integrate Process Plan with task aggregation service (AC: 3, 4)
  - [ ] Add Process Plan provider to task aggregation orchestrator
  - [ ] Implement Process Plan task synchronization
  - [ ] Add Process Plan to scheduled sync jobs
  - [ ] Update task dashboard to display Process Plan tasks
- [ ] Task 6: Update frontend for Process Plan integration (AC: 1, 4)
  - [ ] Add Process Plan option to Integration Settings page
  - [ ] Update TaskCard component for Process Plan source indicator
  - [ ] Add Process Plan-specific task filtering
  - [ ] Create Process Plan connection status display
- [ ] Task 7: Create comprehensive testing (AC: 1-4)
  - [ ] Write unit tests for Process Plan API client
  - [ ] Write integration tests for Process Plan OAuth2 flow
  - [ ] Create E2E tests for Process Plan integration workflow
  - [ ] Test Process Plan task display and filtering
  - [ ] Performance testing with large Process Plan datasets

## Dev Notes

### Previous Story Insights
From Stories 1.1-2.1, the foundation provides:
- Complete authentication system with GCP Identity Platform
- Microsoft Todo integration with OAuth2 and secure token storage
- ConnectWise Manage integration with service tickets and project tasks
- Unified Task Dashboard with responsive design and multi-source filtering
- Task aggregation service with scheduled synchronization for multiple providers
- Encrypted token storage and comprehensive error handling

### Process Plan API Overview
[Source: Process Plan Developer Documentation]
- **Base URL**: `https://api.processplan.com/v1`
- **Authentication**: OAuth2 with authorization code flow
- **API Endpoints**:
  - `/processes` - Active processes for user
  - `/processes/{id}/steps` - Process steps and tasks
  - `/users/me` - User profile information
- **Rate Limits**: 2000 requests per hour per integration
- **Required Scopes**: `read:processes`, `read:steps`, `read:user`

### Process Plan Data Structures
**Processes:**
```json
{
  "id": "proc_12345",
  "name": "Customer Onboarding",
  "description": "Complete customer setup process",
  "status": "active",
  "assignedTo": "user@company.com",
  "createdAt": "2024-08-01T10:00:00Z",
  "dueDate": "2024-08-10T17:00:00Z",
  "progress": 0.6,
  "currentStep": {
    "id": "step_67890",
    "name": "Setup Account",
    "status": "in_progress"
  }
}
```

**Process Steps:**
```json
{
  "id": "step_67890",
  "processId": "proc_12345",
  "name": "Setup Account",
  "description": "Create customer account in system",
  "status": "pending",
  "assignedTo": "user@company.com",
  "order": 2,
  "estimatedDuration": 120,
  "dueDate": "2024-08-03T17:00:00Z",
  "dependencies": ["step_67889"]
}
```

### Data Model Extensions
[Source: packages/shared-types from previous stories]
```typescript
interface Task {
  // Existing fields...
  id: string;
  title: string;
  description?: string;
  status: 'pending' | 'in_progress' | 'completed';
  priority?: 'low' | 'medium' | 'high';
  dueDate?: Date;
  source: 'microsoft' | 'connectwise' | 'processplan';
  
  // Process Plan-specific extensions
  sourceData: {
    // Microsoft Todo fields...
    // ConnectWise fields...
    // Process Plan fields
    processId?: string;
    processName?: string;
    stepId?: string;
    stepOrder?: number;
    estimatedDuration?: number;
    progress?: number;
    dependencies?: string[];
    isProcessOverview?: boolean; // true for process-level tasks
  };
  
  // Process Plan specific fields for better queryability
  processId?: string;
  processName?: string;
  stepOrder?: number;
  estimatedDuration?: number;
}

interface Integration {
  // Existing fields...
  provider: 'microsoft' | 'connectwise' | 'processplan';
  
  // Process Plan-specific configuration
  config?: {
    // ConnectWise fields...
    // Process Plan fields
    userId?: string;
    teamId?: string;
    accessLevel?: 'user' | 'team' | 'admin';
  };
}
```

### Process Plan Authentication Flow
1. **OAuth2 Initiation**: Redirect to Process Plan OAuth2 authorization
2. **Scope Request**: Request read:processes, read:steps, read:user scopes
3. **Callback Handling**: Receive authorization code and exchange for tokens
4. **Token Storage**: Encrypt and store access/refresh tokens
5. **User Mapping**: Store Process Plan user ID for process filtering
6. **API Access**: Use tokens to authenticate Process Plan API calls

### API Integration Architecture
[Source: architecture/backend-architecture.md]
- **Process Plan Provider**: `apps/api/src/integration/providers/processplan/`
- **API Client**: Process Plan REST API wrapper with error handling
- **Task Transformation**: Convert Process Plan processes/steps to unified Task format
- **Sync Strategy**: Incremental sync with process status changes
- **Process Hierarchy**: Handle both process-level and step-level tasks

### Process Plan Task Mapping Strategy
**Two-Level Task Creation:**
1. **Process-Level Tasks**: Overall process tracking with progress indication
2. **Step-Level Tasks**: Individual actionable steps within processes

**Task Creation Logic:**
- Create one task per active process (overview/tracking)
- Create one task per pending/in-progress step within active processes
- Link step tasks to parent process via processId
- Update process progress based on completed steps

### Frontend Integration Points
[Source: architecture/frontend-architecture.md]
- **Integration Settings**: Add Process Plan connection option
- **Task Display**: Process Plan source badge with distinctive styling
- **Process Hierarchy**: Visual indication of process vs. step tasks
- **Progress Display**: Process completion percentage in task cards
- **Filtering**: Add Process Plan-specific filters (process name, step status)

### Security Considerations
[Source: architecture/security-and-performance.md]
- **Token Security**: Encrypt Process Plan tokens with existing encryption service
- **Scope Limitation**: Request minimal required scopes for data access
- **Rate Limiting**: Respect Process Plan API rate limits (2000/hour)
- **Data Privacy**: Handle process data with appropriate confidentiality

### Performance Requirements
- **Sync Performance**: Handle 100+ active processes with 500+ steps efficiently
- **API Efficiency**: Batch process and step requests where possible
- **Hierarchical Display**: Efficient rendering of process hierarchy in UI
- **Progress Calculation**: Real-time progress updates without performance impact

### File Locations
Based on established patterns from Microsoft and ConnectWise integrations:
- Process Plan provider: `apps/api/src/integration/providers/processplan/`
- Process Plan module: `apps/api/src/integration/providers/processplan/processplan.module.ts`
- Process Plan service: `apps/api/src/integration/providers/processplan/processplan.service.ts`
- Process Plan API client: `apps/api/src/integration/providers/processplan/processplan-api.service.ts`
- Process Plan auth controller: `apps/api/src/integration/providers/processplan/processplan-auth.controller.ts`
- Frontend integration page: `apps/web/src/app/integrations/page.tsx` (extend existing)
- Process Plan types: `packages/shared-types/src/processplan.ts`

### Technical Constraints
- TypeScript 5.5.x must be used consistently across all packages
- Follow established OAuth2 patterns from Microsoft and ConnectWise integrations
- Use existing encrypted token storage service
- Integrate with existing task aggregation service
- Maintain compatibility with existing Task interface
- Process Plan API rate limits must be respected
- Handle hierarchical process/step relationship efficiently

### Integration Testing Strategy
- **Unit Tests**: Process Plan API client, task transformation, OAuth2 flow
- **Integration Tests**: End-to-end Process Plan connection and task fetching
- **Hierarchy Tests**: Process and step task creation and linking
- **Security Tests**: Token encryption, OAuth2 flow security, API rate limiting
- **Performance Tests**: Large process dataset handling, sync performance

### Process Plan UI Considerations
- **Process Indicators**: Visual distinction between process and step tasks
- **Progress Bars**: Process completion visualization in task cards
- **Hierarchy Display**: Indentation or grouping for step tasks under processes
- **Filtering Options**: Filter by process name, step status, completion percentage
- **Deep Linking**: Links to Process Plan process and step views

## Testing
[Source: architecture/testing-coding-error-handling-and-monitoring-standards.md]
- **Unit Tests**: Process Plan API service, task transformation logic, OAuth2 handling
- **Integration Tests**: Process Plan API integration, task synchronization, error scenarios
- **E2E Tests**: Complete Process Plan integration workflow, task display, filtering
- **Security Tests**: Token encryption, OAuth2 flow security, API validation
- **Performance Tests**: Large process list handling, API rate limiting, sync efficiency
- **Hierarchy Tests**: Process and step task relationships, progress calculation

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-02 | 1.0 | Initial story creation | Claude Code |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled during implementation*

### Debug Log References
*To be filled during implementation*

### Completion Notes List
*To be filled during implementation*

### File List
*To be filled during implementation*

## QA Results
*Results from QA Agent review will be populated here after implementation*