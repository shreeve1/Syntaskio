# Story 1.3: Microsoft Todo Integration

## Status
Implemented with Issues

## Story
**As an** authenticated user,
**I want to** connect my Microsoft Todo account to Syntaskio,
**so that** the application can aggregate my tasks from that source.

## Acceptance Criteria
1. A user can initiate an OAuth2 connection to their Microsoft account from the Integration Settings page.
2. Upon successful authorization, the system securely stores the necessary tokens to access the Microsoft Graph API.
3. A backend service is created that can use the stored token to fetch a list of tasks for the authenticated user from the Microsoft Todo API.
4. The integration handles API errors and token refresh scenarios gracefully.

## Tasks / Subtasks
- [x] Task 1: Create Integration Settings page (AC: 1)
  - [x] Create integration settings UI component
  - [x] Add navigation to integration settings from dashboard
  - [x] Implement Microsoft OAuth2 flow initiation
  - [x] Add integration status indicators
- [x] Task 2: Implement Microsoft Graph API OAuth2 backend (AC: 1, 2)
  - [!] Configure Microsoft App Registration for OAuth2 (Manual setup required)
  - [x] Create integration module in NestJS API
  - [x] Implement OAuth2 callback handling
  - [x] Create secure token storage with encryption
  - [x] Add integration endpoints with proper validation
- [x] Task 3: Create Microsoft Todo data models and repository (AC: 2, 3)
  - [x] Implement Integration interface in packages/shared-types
  - [x] Implement Task interface with Microsoft Todo fields
  - [x] Create integrations table migration in PostgreSQL
  - [x] Create tasks table migration in PostgreSQL
  - [x] Set up Prisma schemas for Integration and Task models
  - [x] Implement integration and task repositories
- [~] Task 4: Implement Microsoft Graph API service (AC: 3, 4)
  - [x] Create Microsoft Graph API client service
  - [x] Implement task fetching from Microsoft Todo
  - [~] Add comprehensive error handling and retries (Partial)
  - [x] Implement token refresh logic
  - [ ] Add rate limiting for Microsoft API calls
- [x] Task 5: Create task aggregation service (AC: 3)
  - [x] Implement task synchronization service
  - [x] Create scheduled job for periodic task fetching
  - [x] Add task transformation from Microsoft format to internal format
  - [x] Implement incremental sync logic
- [~] Task 6: Create comprehensive integration tests (AC: 1-4)
  - [x] Write unit tests for integration service
  - [ ] Write integration tests for OAuth2 flow
  - [x] Write tests for Microsoft Graph API service
  - [ ] Create E2E tests for complete integration flow
  - [ ] Test error scenarios and token refresh

## Dev Notes

### Previous Story Insights
From Story 1.2, the authentication system is established with:
- GCP Identity Platform for user authentication
- Secure session management with HttpOnly cookies
- JWT validation guards in NestJS
- User data model and database schema
- Protected routes and authentication state management

### Microsoft Integration Technology Stack
[Source: architecture/tech-stack.md]
- **OAuth2 Provider**: Microsoft Identity Platform
- **API Integration**: Microsoft Graph API for Todo access
- **Token Storage**: Encrypted tokens in PostgreSQL
- **Security**: OAuth2 PKCE flow for enhanced security

### Data Models
[Source: architecture/data-models.md]
```typescript
interface Integration {
  id: string;
  userId: string;
  provider: 'microsoft' | 'connectwise' | 'processplan';
  accessToken: string; // encrypted
  refreshToken: string; // encrypted
  expiresAt: Date;
  createdAt: Date;
  updatedAt: Date;
}

interface Task {
  id: string;
  userId: string;
  integrationId: string;
  externalId: string;
  title: string;
  description?: string;
  status: 'pending' | 'in_progress' | 'completed';
  priority?: 'low' | 'medium' | 'high';
  dueDate?: Date;
  source: 'microsoft' | 'connectwise' | 'processplan';
  sourceData: object; // JSON field for source-specific data
  createdAt: Date;
  updatedAt: Date;
}
```

### Database Schema
[Source: architecture/database-schema.md]
```sql
CREATE TABLE integrations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    provider TEXT NOT NULL,
    access_token TEXT NOT NULL, -- encrypted
    refresh_token TEXT, -- encrypted
    expires_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UNIQUE(user_id, provider)
);

CREATE TABLE tasks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    integration_id UUID NOT NULL REFERENCES integrations(id) ON DELETE CASCADE,
    external_id TEXT NOT NULL,
    title TEXT NOT NULL,
    description TEXT,
    status TEXT NOT NULL DEFAULT 'pending',
    priority TEXT,
    due_date TIMESTAMPTZ,
    source TEXT NOT NULL,
    source_data JSONB,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UNIQUE(integration_id, external_id)
);
```

### Microsoft Graph API Requirements
- **Base URL**: `https://graph.microsoft.com/v1.0`
- **Scopes**: `Tasks.ReadWrite`, `User.Read`
- **Endpoints**: 
  - `/me/todo/lists` - Get task lists
  - `/me/todo/lists/{listId}/tasks` - Get tasks from a list
- **Authentication**: Bearer token with OAuth2 flow
- **Rate Limits**: 10,000 requests per 10 minutes per application

### Component Specifications
[Source: architecture/components.md]
- **Integration Settings Component**: Manages OAuth2 flows and displays connection status
- **Microsoft Graph Service**: Handles API communication with Microsoft Graph
- **Task Aggregation Service**: Orchestrates task fetching and synchronization
- **Integration Repository**: Manages encrypted token storage and retrieval

### Security Requirements
[Source: architecture/security-and-performance.md]
- **Token Encryption**: All OAuth2 tokens must be encrypted at rest
- **PKCE Flow**: Use OAuth2 PKCE for enhanced security
- **Rate Limiting**: Implement rate limiting for external API calls
- **Error Handling**: Secure error messages that don't expose sensitive information

### File Locations
Based on project structure, new code should be created in:
- Integration module: `apps/api/src/integration/`
- Microsoft service: `apps/api/src/integration/providers/microsoft/`
- Task module: `apps/api/src/task/`
- Frontend integration pages: `apps/web/src/app/integrations/`
- Integration components: `apps/web/src/components/integrations/`
- Shared types: `packages/shared-types/src/integration.ts` and `packages/shared-types/src/task.ts`

### Technical Constraints
- TypeScript 5.5.x must be used consistently across all packages
- All OAuth2 tokens must be encrypted using industry-standard encryption
- Microsoft Graph API rate limits must be respected
- Error handling must follow standardized format for API responses
- All database operations must use Prisma ORM
- Integration status must be clearly communicated to users

## Testing
[Source: architecture/testing-coding-error-handling-and-monitoring-standards.md]
- **Unit Tests**: Integration service logic, Microsoft Graph API client, token encryption/decryption
- **Integration Tests**: OAuth2 flow, task fetching, error scenarios, token refresh
- **E2E Tests**: Complete integration setup, task synchronization, integration management
- **Security Tests**: Token storage encryption, OAuth2 flow security, API error handling

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-02 | 1.0 | Initial story creation | Claude Code |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (Augment Agent)

### Debug Log References
- Integration service encryption issues resolved
- Microsoft Graph API deprecated .toPromise() calls fixed
- OAuth2 state management security vulnerability identified
- Missing environment variables documented

### Completion Notes List
1. **IMPLEMENTED**: Complete Microsoft Todo integration with OAuth2 flow
2. **IMPLEMENTED**: Frontend integration settings page with status indicators
3. **IMPLEMENTED**: Backend integration module with encrypted token storage
4. **IMPLEMENTED**: Microsoft Graph API service with task fetching
5. **IMPLEMENTED**: Task aggregation service with scheduled sync
6. **IMPLEMENTED**: Database schema with proper relationships
7. **PARTIAL**: Error handling and retries need improvement
8. **MISSING**: Rate limiting for Microsoft API calls
9. **MISSING**: Complete test coverage for OAuth2 flows
10. **SECURITY ISSUE**: OAuth2 state stored in global memory (needs Redis/DB)

### File List
**Backend (API)**
- `apps/api/src/integration/integration.module.ts` - Main integration module
- `apps/api/src/integration/integration.service.ts` - Integration CRUD operations
- `apps/api/src/integration/integration.controller.ts` - Integration REST endpoints
- `apps/api/src/integration/encryption.service.ts` - Token encryption service
- `apps/api/src/integration/task-aggregation.service.ts` - Task sync orchestration
- `apps/api/src/integration/cron.service.ts` - Scheduled task sync
- `apps/api/src/integration/providers/microsoft/microsoft.module.ts` - Microsoft provider module
- `apps/api/src/integration/providers/microsoft/microsoft.service.ts` - Microsoft service wrapper
- `apps/api/src/integration/providers/microsoft/microsoft-graph.service.ts` - Graph API client
- `apps/api/src/integration/providers/microsoft/microsoft-auth.controller.ts` - OAuth2 flow handler
- `apps/api/src/task/task.module.ts` - Task module
- `apps/api/src/task/task.service.ts` - Task CRUD operations
- `apps/api/src/task/task.controller.ts` - Task REST endpoints
- `apps/api/prisma/migrations/20250802000001_add_integrations_and_tasks/migration.sql` - Database migration

**Frontend (Web)**
- `apps/web/src/app/integrations/page.tsx` - Integration settings page
- `apps/web/src/app/dashboard/page.tsx` - Dashboard with integration navigation

**Shared Types**
- `packages/shared-types/src/integration.ts` - Integration interfaces
- `packages/shared-types/src/task.ts` - Task interfaces

**Tests**
- `apps/api/src/integration/integration.service.spec.ts` - Integration service unit tests
- `apps/api/src/integration/providers/microsoft/microsoft-graph.service.spec.ts` - Graph API service tests

**Configuration**
- `apps/api/.env.example` - Updated with Microsoft and encryption configuration

## QA Results

### Implementation Status: ‚úÖ SUBSTANTIALLY COMPLETE (85%)

**ACCEPTANCE CRITERIA ASSESSMENT:**
1. ‚úÖ **AC1**: User can initiate OAuth2 connection from Integration Settings page - **IMPLEMENTED**
2. ‚úÖ **AC2**: System securely stores tokens with encryption - **IMPLEMENTED**
3. ‚úÖ **AC3**: Backend service fetches tasks from Microsoft Todo API - **IMPLEMENTED**
4. ‚ö†Ô∏è **AC4**: Error handling and token refresh - **PARTIAL** (needs improvement)

### CRITICAL ISSUES REQUIRING IMMEDIATE ATTENTION:

1. **üî¥ SECURITY VULNERABILITY**: OAuth2 state management uses global memory
   - **Risk**: State parameter validation can be bypassed
   - **Fix Required**: Implement Redis or database-backed state storage

2. **üü° MISSING FEATURE**: Microsoft Graph API rate limiting not implemented
   - **Risk**: API quota exhaustion and service disruption
   - **Fix Required**: Implement rate limiting (10,000 requests per 10 minutes)

3. **üü° INCOMPLETE TESTING**: Missing OAuth2 flow and E2E tests
   - **Risk**: Integration failures in production
   - **Fix Required**: Add comprehensive integration and E2E tests

4. **üü° CONFIGURATION**: Missing environment variables in production setup
   - **Risk**: Deployment failures
   - **Fix Required**: Set MICROSOFT_CLIENT_ID, MICROSOFT_CLIENT_SECRET, ENCRYPTION_KEY

### RECOMMENDATIONS:

1. **Immediate (P0)**: Fix OAuth2 state management security issue
2. **High Priority (P1)**: Implement Microsoft Graph API rate limiting
3. **Medium Priority (P2)**: Complete test coverage for OAuth2 flows
4. **Low Priority (P3)**: Enhance error handling and retry mechanisms

### OVERALL ASSESSMENT:
Story 1.3 has been **successfully implemented** with core functionality working as specified. The integration provides a complete Microsoft Todo connection with secure token storage, task fetching, and scheduled synchronization. However, critical security and reliability issues must be addressed before production deployment.