# Story 2.3: Bi-Directional Status Synchronization

## Status
Ready for Implementation

## Story
**As a** user,
**I want to** mark a task as complete within Syntaskio and have that status reflected in the original system,
**so that** I don't have to update tasks in two different places.

## Acceptance Criteria
1. When a task is marked "complete" in the Syntaskio UI, a request is sent to the backend.
2. The backend service correctly identifies the source system of the task.
3. The service makes an API call to the source system (e.g., Microsoft Todo, ConnectWise) to update the task's status to complete.
4. The change is reflected in the source system within 5 seconds.
5. The system includes error handling for failed synchronization attempts.

## Tasks / Subtasks
- [ ] Task 1: Create bi-directional sync service architecture (AC: 1, 2)
  - [ ] Design sync queue system for reliable status updates
  - [ ] Create task update event system with proper error handling
  - [ ] Implement provider routing logic for source system identification
  - [ ] Add sync status tracking and retry mechanisms
- [ ] Task 2: Implement Microsoft Todo bi-directional sync (AC: 2, 3, 4)
  - [ ] Add task completion API endpoint in Microsoft Graph service
  - [ ] Implement Microsoft Todo task status update functionality
  - [ ] Add error handling for Microsoft API failures
  - [ ] Create Microsoft-specific sync validation and confirmation
- [ ] Task 3: Implement ConnectWise bi-directional sync (AC: 2, 3, 4)
  - [ ] Add ticket/task completion API endpoints in ConnectWise service
  - [ ] Implement ConnectWise status update for service tickets
  - [ ] Implement ConnectWise status update for project tasks
  - [ ] Add ConnectWise-specific error handling and validation
- [ ] Task 4: Implement Process Plan bi-directional sync (AC: 2, 3, 4)
  - [ ] Add process step completion API endpoints in Process Plan service
  - [ ] Implement Process Plan step status update functionality
  - [ ] Handle process progression logic when steps are completed
  - [ ] Add Process Plan-specific error handling and validation
- [ ] Task 5: Create sync orchestration and queue management (AC: 1, 4, 5)
  - [ ] Implement sync queue with Redis/database backing
  - [ ] Add sync job processing with exponential backoff retry
  - [ ] Create sync status monitoring and failure recovery
  - [ ] Implement real-time sync confirmation and UI updates
- [ ] Task 6: Update frontend for bi-directional sync (AC: 1, 5)
  - [ ] Add optimistic UI updates for task completion
  - [ ] Implement sync status indicators and error display
  - [ ] Add manual retry functionality for failed syncs
  - [ ] Create sync conflict resolution UI
- [ ] Task 7: Create comprehensive testing (AC: 1-5)
  - [ ] Write unit tests for sync services and queue management
  - [ ] Write integration tests for each provider's sync functionality
  - [ ] Create E2E tests for complete bi-directional sync workflow
  - [ ] Test error scenarios and sync failure recovery
  - [ ] Performance testing with high-volume sync operations

## Dev Notes

### Previous Story Insights
From Stories 1.1-2.2, the foundation provides:
- Complete authentication system with GCP Identity Platform
- Microsoft Todo, ConnectWise Manage, and Process Plan integrations
- Unified Task Dashboard with multi-source task display
- Task aggregation service with scheduled synchronization
- Encrypted token storage and comprehensive error handling
- Task data models supporting all three integration sources

### Bi-Directional Sync Architecture
[Source: architecture/backend-architecture.md]
- **Sync Queue**: Redis-backed queue for reliable sync job processing
- **Provider Routing**: Dynamic routing to appropriate provider sync methods
- **Event System**: Task update events triggering sync operations
- **Status Tracking**: Sync attempt logging and failure monitoring
- **Real-time Updates**: WebSocket/SSE for immediate UI sync confirmation

### Provider-Specific Sync Requirements

#### Microsoft Todo Sync
- **API Endpoint**: `PATCH /me/todo/lists/{listId}/tasks/{taskId}`
- **Status Mapping**: 
  - `completed` -> `completedDateTime: <timestamp>`
  - `pending` -> `completedDateTime: null`
- **Error Scenarios**: Token expiration, task not found, permission denied
- **Sync Validation**: Verify task completion in Microsoft Todo

#### ConnectWise Manage Sync
- **Service Tickets**: `PATCH /service/tickets/{id}`
- **Project Tasks**: `PATCH /project/projects/{projectId}/tasks/{taskId}`
- **Status Mapping**:
  - `completed` -> `status: "Closed"` (tickets) or `status: "Complete"` (tasks)
  - `pending` -> `status: "New"` or original status
- **Error Scenarios**: Insufficient permissions, workflow restrictions, invalid status transitions
- **Validation**: Confirm status change in ConnectWise system

#### Process Plan Sync
- **API Endpoint**: `PATCH /processes/{processId}/steps/{stepId}`
- **Status Mapping**:
  - `completed` -> `status: "completed", completedAt: <timestamp>`
  - `in_progress` -> `status: "in_progress", startedAt: <timestamp>`
- **Process Logic**: Auto-advance process when all steps complete
- **Error Scenarios**: Step dependencies not met, process locked, invalid transitions

### Sync Queue Data Model
```typescript
interface SyncJob {
  id: string;
  taskId: string;
  userId: string;
  source: 'microsoft' | 'connectwise' | 'processplan';
  action: 'complete' | 'reopen' | 'update';
  targetStatus: string;
  originalData: object;
  attempts: number;
  maxAttempts: number;
  status: 'pending' | 'processing' | 'completed' | 'failed';
  error?: string;
  scheduledAt: Date;
  processedAt?: Date;
  createdAt: Date;
}

interface SyncResult {
  success: boolean;
  taskId: string;
  source: string;
  syncedAt: Date;
  error?: string;
  sourceResponse?: object;
}
```

### Error Handling Strategy
[Source: architecture/testing-coding-error-handling-and-monitoring-standards.md]

#### Retryable Errors
- Network timeouts and connectivity issues
- Rate limiting (429) responses
- Temporary server errors (5xx)
- Token expiration (auto-refresh and retry)

#### Non-Retryable Errors
- Task not found (404)
- Insufficient permissions (403)
- Invalid status transitions
- Malformed requests (400)

#### Retry Logic
- **Exponential Backoff**: 1s, 2s, 4s, 8s, 16s intervals
- **Max Attempts**: 5 retries per sync job
- **Dead Letter Queue**: Failed jobs moved to manual review queue
- **Circuit Breaker**: Temporary provider disable on repeated failures

### Real-Time Sync Confirmation
- **WebSocket Events**: Real-time sync status updates to connected clients
- **Optimistic Updates**: Immediate UI updates with rollback on failure
- **Sync Indicators**: Visual feedback for sync in progress, success, and failure
- **Manual Retry**: User-initiated retry for failed sync operations

### Performance Requirements
- **Sync Latency**: 95% of syncs complete within 5 seconds
- **Queue Throughput**: Handle 1000+ sync operations per hour
- **Error Recovery**: Automatic retry with exponential backoff
- **UI Responsiveness**: Optimistic updates with sub-100ms response

### Security Considerations
[Source: architecture/security-and-performance.md]
- **Token Security**: Secure token retrieval for sync operations
- **Authorization**: Verify user permissions for task updates
- **Audit Logging**: Track all sync attempts and outcomes
- **Rate Limiting**: Respect provider API limits during sync operations

### File Locations
Based on established integration patterns:
- Sync service: `apps/api/src/sync/`
- Sync queue: `apps/api/src/sync/queue.service.ts`
- Sync orchestrator: `apps/api/src/sync/sync-orchestrator.service.ts`
- Provider sync services: `apps/api/src/integration/providers/{provider}/{provider}-sync.service.ts`
- Sync controller: `apps/api/src/sync/sync.controller.ts`
- Frontend sync store: `apps/web/src/stores/sync.store.ts`
- Sync types: `packages/shared-types/src/sync.ts`

### Database Schema Updates
```sql
CREATE TABLE sync_jobs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    task_id UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    source TEXT NOT NULL,
    action TEXT NOT NULL,
    target_status TEXT NOT NULL,
    original_data JSONB,
    attempts INTEGER DEFAULT 0,
    max_attempts INTEGER DEFAULT 5,
    status TEXT DEFAULT 'pending',
    error TEXT,
    scheduled_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    processed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_sync_jobs_status ON sync_jobs(status);
CREATE INDEX idx_sync_jobs_scheduled_at ON sync_jobs(scheduled_at);
CREATE INDEX idx_sync_jobs_user_id ON sync_jobs(user_id);
```

### Technical Constraints
- TypeScript 5.5.x must be used consistently across all packages
- Redis required for sync queue (or database-backed alternative)
- All sync operations must be idempotent
- Sync jobs must survive application restarts
- Provider API rate limits must be respected during sync
- All sync attempts must be auditable and trackable

### Integration Points
- **Task Service**: Task status updates trigger sync jobs
- **Integration Services**: Provider-specific sync implementations
- **WebSocket Service**: Real-time sync status broadcasting
- **Queue Service**: Reliable job processing and retry logic
- **Audit Service**: Sync operation logging and monitoring

## Testing
[Source: architecture/testing-coding-error-handling-and-monitoring-standards.md]
- **Unit Tests**: Sync services, queue management, provider sync implementations
- **Integration Tests**: End-to-end sync workflows for each provider
- **E2E Tests**: Complete bi-directional sync with UI confirmation
- **Performance Tests**: High-volume sync operations, queue throughput
- **Error Scenario Tests**: Network failures, API errors, token expiration
- **Security Tests**: Authorization checks, audit logging, token handling

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-02 | 1.0 | Initial story creation | Claude Code |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled during implementation*

### Debug Log References
*To be filled during implementation*

### Completion Notes List
*To be filled during implementation*

### File List
*To be filled during implementation*

## QA Results
*Results from QA Agent review will be populated here after implementation*